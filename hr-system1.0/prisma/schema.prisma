// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

// ðŸŽ¯ Set the provider to 'mongodb'
datasource db {
  provider = "mongodb"
  // âœ… Use the standard 'DATABASE_URL' environment variable
  // This is often more reliable, especially when encountering environment variable errors.
  url      = env("DATABASE_URL")
}

// =========================================================
// Enums for fixed values
// =========================================================

enum ProjectStatus {
  PLANNED @map("Planned")
  IN_PROGRESS @map("In Progress")
  COMPLETED @map("Completed")
  CANCELLED @map("Cancelled")
  ON_HOLD @map("On Hold")
}

enum TaskPriority {
  Low
  Medium
  High
  Critical
}

enum TaskStatus {
  To_Do @map("To Do")
  In_Progress @map("In Progress")
  Testing
  Done
}

// =========================================================
// 1. ROLES Collection (Lookup)
// =========================================================
model Role {
  // ðŸŽ¯ MongoDB ID pattern: String type with @id, @default(auto()), and @db.ObjectId
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  name  String @unique
  users User[]

  @@map("roles")
}

// =========================================================
// 2. USERS Collection (Staff/HR Data)
// =========================================================
model User {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  fullName      String
  email         String          @unique
  passwordHash  String
  roleId        String          // Reference to the Role ID
  jobTitle      String?
  department    String?
  phoneNumber   String?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  // Relationships
  role            Role            @relation(fields: [roleId], references: [id])
  managedProjects Project[]       @relation("ManagerProjects") // Projects this user manages
  projects        UserProject[]   // Projects this user is assigned to
  tasksAssigned   Task[]          @relation("AssignedTasks") // Tasks assigned to this user

  @@map("users")
}

// =========================================================
// 3. PROJECTS Collection
// =========================================================
model Project {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  startDate     DateTime
  endDate       DateTime?       // Making endDate optional for flexibility
  status        ProjectStatus   @default(PLANNED) // Using PLANNED from the new enum
  managerId     String          @db.ObjectId // Reference to the User ID of the Project Manager
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt // Added updatedAt for tracking changes

  // Relationships
  manager       User            @relation("ManagerProjects", fields: [managerId], references: [id])
  teamMembers   UserProject[]   // The team members assigned to this project
  tasks         Task[]          // The tasks belonging to this project

  @@map("projects")
}

// =========================================================
// 4. USER_PROJECTS Collection (Many-to-Many Join Table)
// =========================================================
model UserProject {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  userId        String @db.ObjectId
  projectId     String @db.ObjectId

  user          User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project       Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("user_projects")
}

// =========================================================
// 5. TASKS Collection
// =========================================================
model Task {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  projectId         String          @db.ObjectId
  assignedToUserId  String          @db.ObjectId
  title             String
  description       String?
  priority          TaskPriority    @default(Medium)
  status            TaskStatus      @default(To_Do)
  dueDate           DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relationships
  project           Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo        User    @relation("AssignedTasks", fields: [assignedToUserId], references: [id])

  @@map("tasks")
}