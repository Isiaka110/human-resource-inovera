// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

// ðŸŽ¯ Set the provider to 'mongodb'
datasource db {
  provider = "mongodb"
  // âœ… Use the standard 'DATABASE_URL' environment variable
  url          = env("DATABASE_URL")
}

// ... (Enums are unchanged) ...

// =========================================================
// Enums for fixed values
// =========================================================

enum ProjectStatus {
  PLANNED @map("Planned")
  IN_PROGRESS @map("In Progress")
  COMPLETED @map("Completed")
  CANCELLED @map("Cancelled")
  ON_HOLD @map("On Hold")
}

enum TaskPriority {
  Low
  Medium
  High
  Critical
}

enum TaskStatus {
  To_Do @map("To Do")
  In_Progress @map("In Progress")
  Testing
  Done
}

// --- UPDATED ENUM FOR LEAVE MANAGEMENT ---
enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED 
}

// =========================================================
// 1. ROLES Collection (Lookup)
// =========================================================
model Role {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  name  String @unique
  users User[]

  @@map("roles")
}

// =========================================================
// 2. USERS Collection (Staff/HR Data)
// =========================================================
model User {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  fullName          String
  email             String          @unique
  hashedPassword    String          
  roleId            String          @db.ObjectId 
  jobTitle          String?
  department        String?
  phoneNumber       String?
  isActive          Boolean         @default(true)
  managerId         String?         @db.ObjectId 
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relationships
  role              Role          @relation(fields: [roleId], references: [id])
  managedProjects   Project[]     @relation("ManagerProjects") 
  projects          UserProject[]
  tasksAssigned     Task[]        @relation("AssignedTasks") 
  leaveRequests     LeaveRequest[]

  // FIX 1: Explicitly set onUpdate: NoAction for the Manager self-relation
  manager           User?         @relation("DirectReports", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction) 
  directReports     User[]        @relation("DirectReports")
  
  approvedRequests  LeaveRequest[] @relation("ApprovedRequests") 

  leaveBalances     LeaveBalance[] 

  @@map("users")
}

// =========================================================
// 3. PROJECTS Collection
// =========================================================
model Project {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  name          String
  description   String?
  startDate     DateTime
  endDate       DateTime?       
  status        ProjectStatus   @default(PLANNED) 
  managerId     String          @db.ObjectId 

  // FIX 2: Explicitly set onUpdate: NoAction for the Project Manager relation
  manager       User            @relation("ManagerProjects", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction) 
  teamMembers   UserProject[]
  tasks         Task[]          

  @@map("projects")
}

// =========================================================
// 4. USER_PROJECTS Collection (Many-to-Many Join Table)
// =========================================================
model UserProject {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  userId        String @db.ObjectId
  projectId     String @db.ObjectId

  // FIX 3: Explicitly set onUpdate: NoAction
  user          User    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction) 
  // FIX 4: Explicitly set onUpdate: NoAction
  project       Project @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction) 

  @@unique([userId, projectId])
  @@map("user_projects")
}

// =========================================================
// 5. TASKS Collection
// =========================================================
model Task {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  projectId         String          @db.ObjectId
  assignedToUserId  String          @db.ObjectId
  title             String
  description       String?
  priority          TaskPriority    @default(Medium)
  status            TaskStatus      @default(To_Do)
  dueDate           DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // FIX 5: Explicitly set onUpdate: NoAction
  project           Project @relation(fields: [projectId], references: [id], onDelete: NoAction, onUpdate: NoAction) 
  // FIX 6: Explicitly set onUpdate: NoAction
  assignedTo        User    @relation("AssignedTasks", fields: [assignedToUserId], references: [id], onDelete: NoAction, onUpdate: NoAction) 

  @@map("tasks")
}

// =========================================================
// 6. LEAVE MANAGEMENT COLLECTIONS
// =========================================================

model LeaveType {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  name           String         @unique 
  defaultDays    Float          @default(0) 
  requests       LeaveRequest[] 

  leaveBalances  LeaveBalance[]

  @@map("leave_types")
}

model LeaveBalance {
  id           String @id @default(auto()) @map("_id") @db.ObjectId
  
  userId       String @db.ObjectId
  leaveTypeId  String @db.ObjectId
  
  currentBalance Float @default(0) 
  
  // RELATIONSHIPS
  // FIX 7: Explicitly set onUpdate: NoAction
  user         User @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction) 
  leaveType    LeaveType @relation(fields: [leaveTypeId], references: [id])
  
  @@unique([userId, leaveTypeId])
  @@map("leave_balances")
}

model LeaveRequest {
  id            String      @id @default(auto()) @map("_id") @db.ObjectId
  
  userId        String      @db.ObjectId 
  typeId        String      @db.ObjectId 
  approverId    String?     @db.ObjectId 
  
  startDate     DateTime
  endDate       DateTime
  durationDays  Float       
  reason        String?
  status        LeaveStatus @default(PENDING)
  
  // Timestamps
  submittedAt   DateTime    @default(now())
  updatedAt     DateTime    @updatedAt 

  // Relationships
  // FIX 8: Explicitly set onUpdate: NoAction
  user          User        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  type          LeaveType   @relation(fields: [typeId], references: [id])
  // FIX 9: Explicitly set onUpdate: NoAction
  approver      User?       @relation("ApprovedRequests", fields: [approverId], references: [id], onDelete: NoAction, onUpdate: NoAction) 

  @@map("leave_requests")
}